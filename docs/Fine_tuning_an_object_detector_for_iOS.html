---

title: Fine Tuning ~ MLmodel conversion FasterRCNN with MobileNet backbone


keywords: fastai
sidebar: home_sidebar



nb_path: "nbs/Tutorials/12_Fine_tuning_an_object_detector_for_iOS.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/Tutorials/12_Fine_tuning_an_object_detector_for_iOS.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">rich</span> <span class="kn">import</span> <span class="nb">print</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;../../&#39;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>&#39;/home/me/github/RSF&#39;</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>TODO:</p>
<ul>
<li>Link to an experimental fine-tuning study</li>
<li>How does FasterRCNN work?</li>
<li>How does mobileNet work?</li>
<li>What does it mean to fine tune FasterRCNN with a mobilenet backbone?</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Prepare-Data-Module">Prepare Data Module<a class="anchor-link" href="#Prepare-Data-Module"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">LabelEncoder</span>

<span class="n">class_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;soccer_ball&#39;</span><span class="p">,</span> <span class="s1">&#39;background&#39;</span><span class="p">]</span>

<span class="n">le</span> <span class="o">=</span> <span class="n">LabelEncoder</span><span class="p">()</span>
<span class="n">le</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">class_labels</span><span class="p">)</span>

<span class="n">class_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">le</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">le</span><span class="o">.</span><span class="n">classes_</span><span class="p">),</span> <span class="n">le</span><span class="o">.</span><span class="n">classes_</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">class_map</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="font-weight: bold">{</span><span style="color: #000080; font-weight: bold">0</span>: <span style="color: #008000">'background'</span>, <span style="color: #000080; font-weight: bold">1</span>: <span style="color: #008000">'soccer_ball'</span><span style="font-weight: bold">}</span>
</pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">albumentations</span> <span class="k">as</span> <span class="nn">A</span>
<span class="kn">from</span> <span class="nn">albumentations.pytorch.transforms</span> <span class="kn">import</span> <span class="n">ToTensor</span>
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">Compose</span>
<span class="kn">from</span> <span class="nn">ball_detection.dataset</span> <span class="kn">import</span> <span class="n">XMLDetectionDataModule</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="s1">&#39;../data/&#39;</span>

<span class="n">transform</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">Compose</span><span class="p">([</span>
        <span class="n">A</span><span class="o">.</span><span class="n">Flip</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
        <span class="n">A</span><span class="o">.</span><span class="n">ChannelShuffle</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">A</span><span class="o">.</span><span class="n">Blur</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">A</span><span class="o">.</span><span class="n">RandomBrightness</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">0.2</span><span class="p">),</span>
        <span class="n">A</span><span class="o">.</span><span class="n">pytorch</span><span class="o">.</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span>
    <span class="p">],</span> 
    <span class="n">bbox_params</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">BboxParams</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pascal_voc&#39;</span><span class="p">,</span> <span class="n">label_fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;class_labels&#39;</span><span class="p">]),</span>
<span class="p">)</span>

<span class="n">target_transform</span> <span class="o">=</span> <span class="n">Compose</span><span class="p">([</span>
    <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;boxes&#39;</span> <span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">]),</span> <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">le</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;class_labels&#39;</span><span class="p">]))}),</span>
<span class="p">])</span>

<span class="n">dm</span> <span class="o">=</span> <span class="n">XMLDetectionDataModule</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transform</span><span class="p">,</span> <span class="n">target_transform</span><span class="o">=</span><span class="n">target_transform</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">dm</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;use_dir&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-5-22f24b858858&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-green-fg">import</span> torch
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">import</span> albumentations <span class="ansi-green-fg">as</span> A
<span class="ansi-green-intense-fg ansi-bold">      3</span> <span class="ansi-green-fg">from</span> albumentations<span class="ansi-blue-fg">.</span>pytorch<span class="ansi-blue-fg">.</span>transforms <span class="ansi-green-fg">import</span> ToTensor
<span class="ansi-green-intense-fg ansi-bold">      4</span> <span class="ansi-green-fg">from</span> torchvision<span class="ansi-blue-fg">.</span>transforms <span class="ansi-green-fg">import</span> Compose
<span class="ansi-green-intense-fg ansi-bold">      5</span> <span class="ansi-green-fg">from</span> ball_detection<span class="ansi-blue-fg">.</span>dataset <span class="ansi-green-fg">import</span> XMLDetectionDataModule

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/site-packages/albumentations/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      7</span> <span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span>core<span class="ansi-blue-fg">.</span>serialization <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-intense-fg ansi-bold">      8</span> <span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span>augmentations <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-fg">----&gt; 9</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span>imgaug<span class="ansi-blue-fg">.</span>transforms <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/site-packages/albumentations/imgaug/transforms.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-fg">----&gt; 1</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">import</span> imgaug <span class="ansi-green-fg">as</span> ia
<span class="ansi-green-intense-fg ansi-bold">      2</span> 
<span class="ansi-green-intense-fg ansi-bold">      3</span> <span class="ansi-green-fg">try</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span>     <span class="ansi-green-fg">from</span> imgaug <span class="ansi-green-fg">import</span> augmenters <span class="ansi-green-fg">as</span> iaa
<span class="ansi-green-intense-fg ansi-bold">      5</span> <span class="ansi-green-fg">except</span> ImportError<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/site-packages/imgaug/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      7</span> <span class="ansi-green-fg">from</span> imgaug<span class="ansi-blue-fg">.</span>imgaug <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>  <span class="ansi-red-fg"># pylint: disable=redefined-builtin</span>
<span class="ansi-green-intense-fg ansi-bold">      8</span> 
<span class="ansi-green-fg">----&gt; 9</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">import</span> imgaug<span class="ansi-blue-fg">.</span>augmentables <span class="ansi-green-fg">as</span> augmentables
<span class="ansi-green-intense-fg ansi-bold">     10</span> <span class="ansi-green-fg">from</span> imgaug<span class="ansi-blue-fg">.</span>augmentables <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-intense-fg ansi-bold">     11</span> <span class="ansi-green-fg">import</span> imgaug<span class="ansi-blue-fg">.</span>augmenters <span class="ansi-green-fg">as</span> augmenters

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/site-packages/imgaug/augmentables/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span> <span class="ansi-green-fg">from</span> imgaug<span class="ansi-blue-fg">.</span>augmentables<span class="ansi-blue-fg">.</span>lines <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-intense-fg ansi-bold">      7</span> <span class="ansi-green-fg">from</span> imgaug<span class="ansi-blue-fg">.</span>augmentables<span class="ansi-blue-fg">.</span>heatmaps <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-fg">----&gt; 8</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> imgaug<span class="ansi-blue-fg">.</span>augmentables<span class="ansi-blue-fg">.</span>segmaps <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-intense-fg ansi-bold">      9</span> <span class="ansi-green-fg">from</span> imgaug<span class="ansi-blue-fg">.</span>augmentables<span class="ansi-blue-fg">.</span>batches <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/site-packages/imgaug/augmentables/segmaps.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     10</span> 
<span class="ansi-green-intense-fg ansi-bold">     11</span> <span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span><span class="ansi-blue-fg">.</span> <span class="ansi-green-fg">import</span> imgaug <span class="ansi-green-fg">as</span> ia
<span class="ansi-green-fg">---&gt; 12</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span><span class="ansi-blue-fg">.</span>augmenters <span class="ansi-green-fg">import</span> blend <span class="ansi-green-fg">as</span> blendlib
<span class="ansi-green-intense-fg ansi-bold">     13</span> <span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span>base <span class="ansi-green-fg">import</span> IAugmentable
<span class="ansi-green-intense-fg ansi-bold">     14</span> 

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/site-packages/imgaug/augmenters/__init__.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span> <span class="ansi-green-fg">from</span> __future__ <span class="ansi-green-fg">import</span> absolute_import
<span class="ansi-green-intense-fg ansi-bold">      4</span> <span class="ansi-green-fg">from</span> imgaug<span class="ansi-blue-fg">.</span>augmenters<span class="ansi-blue-fg">.</span>base <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-fg">----&gt; 5</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> imgaug<span class="ansi-blue-fg">.</span>augmenters<span class="ansi-blue-fg">.</span>arithmetic <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span> <span class="ansi-green-fg">from</span> imgaug<span class="ansi-blue-fg">.</span>augmenters<span class="ansi-blue-fg">.</span>artistic <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>
<span class="ansi-green-intense-fg ansi-bold">      7</span> <span class="ansi-green-fg">from</span> imgaug<span class="ansi-blue-fg">.</span>augmenters<span class="ansi-blue-fg">.</span>blend <span class="ansi-green-fg">import</span> <span class="ansi-blue-fg">*</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/site-packages/imgaug/augmenters/arithmetic.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     38</span> 
<span class="ansi-green-intense-fg ansi-bold">     39</span> <span class="ansi-green-fg">import</span> imgaug <span class="ansi-green-fg">as</span> ia
<span class="ansi-green-fg">---&gt; 40</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span> <span class="ansi-green-fg">import</span> meta
<span class="ansi-green-intense-fg ansi-bold">     41</span> <span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span><span class="ansi-blue-fg">.</span> <span class="ansi-green-fg">import</span> parameters <span class="ansi-green-fg">as</span> iap
<span class="ansi-green-intense-fg ansi-bold">     42</span> <span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span><span class="ansi-blue-fg">.</span> <span class="ansi-green-fg">import</span> dtypes <span class="ansi-green-fg">as</span> iadt

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/site-packages/imgaug/augmenters/meta.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">     35</span> 
<span class="ansi-green-intense-fg ansi-bold">     36</span> <span class="ansi-green-fg">import</span> imgaug <span class="ansi-green-fg">as</span> ia
<span class="ansi-green-fg">---&gt; 37</span><span class="ansi-red-fg"> from imgaug.augmentables.batches import (Batch, UnnormalizedBatch,
</span><span class="ansi-green-intense-fg ansi-bold">     38</span>                                          _BatchInAugmentation)
<span class="ansi-green-intense-fg ansi-bold">     39</span> <span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span><span class="ansi-blue-fg">.</span> <span class="ansi-green-fg">import</span> parameters <span class="ansi-green-fg">as</span> iap

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/site-packages/imgaug/augmentables/batches.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      7</span> 
<span class="ansi-green-intense-fg ansi-bold">      8</span> <span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span><span class="ansi-blue-fg">.</span> <span class="ansi-green-fg">import</span> imgaug <span class="ansi-green-fg">as</span> ia
<span class="ansi-green-fg">----&gt; 9</span><span class="ansi-red-fg"> </span><span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span> <span class="ansi-green-fg">import</span> normalization <span class="ansi-green-fg">as</span> nlib
<span class="ansi-green-intense-fg ansi-bold">     10</span> <span class="ansi-green-fg">from</span> <span class="ansi-blue-fg">.</span> <span class="ansi-green-fg">import</span> utils
<span class="ansi-green-intense-fg ansi-bold">     11</span> 

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/importlib/_bootstrap.py</span> in <span class="ansi-cyan-fg">_find_and_load</span><span class="ansi-blue-fg">(name, import_)</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/importlib/_bootstrap.py</span> in <span class="ansi-cyan-fg">_find_and_load_unlocked</span><span class="ansi-blue-fg">(name, import_)</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/importlib/_bootstrap.py</span> in <span class="ansi-cyan-fg">_load_unlocked</span><span class="ansi-blue-fg">(spec)</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/importlib/_bootstrap_external.py</span> in <span class="ansi-cyan-fg">exec_module</span><span class="ansi-blue-fg">(self, module)</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/importlib/_bootstrap_external.py</span> in <span class="ansi-cyan-fg">get_code</span><span class="ansi-blue-fg">(self, fullname)</span>

<span class="ansi-green-fg">~/anaconda3/lib/python3.8/importlib/_bootstrap_external.py</span> in <span class="ansi-cyan-fg">_compile_bytecode</span><span class="ansi-blue-fg">(data, name, bytecode_path, source_path)</span>

<span class="ansi-red-fg">KeyboardInterrupt</span>: </pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Prepare-Pytorch-Lightning-Module">Prepare Pytorch-Lightning Module<a class="anchor-link" href="#Prepare-Pytorch-Lightning-Module"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">from</span> <span class="nn">torchvision.models.detection</span> <span class="kn">import</span> <span class="n">FasterRCNN</span>
<span class="kn">from</span> <span class="nn">torchvision.models.detection.faster_rcnn</span> <span class="kn">import</span> <span class="n">FastRCNNPredictor</span>
<span class="kn">from</span> <span class="nn">torchvision.models.detection.rpn</span> <span class="kn">import</span> <span class="n">AnchorGenerator</span>
<span class="kn">from</span> <span class="nn">ball_detection.cnn_module</span> <span class="kn">import</span> <span class="n">TorchVisionDetector</span>

<span class="c1"># backbone = torchvision.models.mobilenet_v2(pretrained=True).features</span>
<span class="c1"># backbone.out_channels = 1280</span>

<span class="c1"># anchor_generator = AnchorGenerator(sizes=((32, 64, 128, 256, 512),),</span>
<span class="c1">#                                    aspect_ratios=((0.5, 1.0, 2.0),))</span>

<span class="c1"># model = FasterRCNN(backbone,</span>
<span class="c1">#                    num_classes=2,</span>
<span class="c1">#                    rpn_anchor_generator=anchor_generator)</span>

<span class="c1">#                    box_roi_pool=roi_pooler)</span>



<span class="c1"># num_classes = 2</span>
<span class="c1"># in_features = module.model.roi_heads.box_predictor.cls_score.in_features</span>
<span class="c1"># module.model.roi_heads.box_predictor = FastRCNNPredictor(in_features, num_classes)</span>

<span class="kn">import</span> <span class="nn">torchvision</span>
<span class="kn">from</span> <span class="nn">torchvision.models.detection.faster_rcnn</span> <span class="kn">import</span> <span class="n">FastRCNNPredictor</span>

<span class="c1"># load a model pre-trained pre-trained on COCO</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">detection</span><span class="o">.</span><span class="n">fasterrcnn_resnet50_fpn</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># replace the classifier with a new one, that has</span>
<span class="c1"># num_classes which is user-defined</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># 1 class (person) + background</span>
<span class="c1"># get number of input features for the classifier</span>
<span class="n">in_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span><span class="o">.</span><span class="n">cls_score</span><span class="o">.</span><span class="n">in_features</span>
<span class="c1"># replace the pre-trained head with a new one</span>
<span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span> <span class="o">=</span> <span class="n">FastRCNNPredictor</span><span class="p">(</span><span class="n">in_features</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>

<span class="n">module</span><span class="o">=</span><span class="n">TorchVisionDetector</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Test-model-forward">Test model forward<a class="anchor-link" href="#Test-model-forward"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">images</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">()))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">module</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
<span class="n">eval_preds</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batchsize: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">eval_preds</span><span class="p">)</span><span class="si">}</span><span class="s2">, output dict keys </span><span class="si">{</span><span class="n">eval_preds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">, shape of bbox outputs: </span><span class="si">{</span><span class="n">eval_preds</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">ball_detection.metrics</span> <span class="kn">import</span> <span class="n">hungarian_loss</span><span class="p">,</span> <span class="n">bbox_iou</span>

<span class="n">iou</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">pred</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">eval_preds</span><span class="p">,</span> <span class="n">targets</span><span class="p">):</span>
    <span class="n">iou</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hungarian_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">[</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">target</span><span class="p">[</span><span class="s1">&#39;bboxes&#39;</span><span class="p">],</span> <span class="n">bbox_iou</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">iou</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">module</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>
<span class="n">train_preds</span> <span class="o">=</span> <span class="n">module</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">targets</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">train_preds</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Set-up-Training-Loop">Set up Training Loop<a class="anchor-link" href="#Set-up-Training-Loop"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">pytorch_lightning</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">loggers</span><span class="o">.</span><span class="n">TensorBoardLogger</span><span class="p">(</span><span class="s1">&#39;tb_logs&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;faster-rcnn-resnet&#39;</span><span class="p">)</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">Trainer</span><span class="p">(</span><span class="n">gpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">checkpoint_callback</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">auto_lr_find</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># debug_trainer.fit(module, dm)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Setup-optimizer">Setup optimizer<a class="anchor-link" href="#Setup-optimizer"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># lr_finder = trainer.tuner.lr_find(module, dm, max_lr=0.01)</span>

<span class="c1"># # Plot with</span>
<span class="c1"># fig = lr_finder.plot(suggest=True)</span>
<span class="c1"># fig.show()</span>

<span class="c1"># new_lr = lr_finder.suggestion()</span>
<span class="c1"># print(&quot;new lr&quot;, new_lr)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Start-Training">Start Training<a class="anchor-link" href="#Start-Training"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">trainer</span><span class="o">.</span><span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># warm y</span>
<span class="n">module</span><span class="o">.</span><span class="n">lr</span> <span class="o">=</span> <span class="mf">0.0005</span>
<span class="n">trainer</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">dm</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">module</span><span class="o">.</span><span class="n">model</span><span class="o">.</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># # import torchvision</span>

<span class="c1"># # # Load a pre-trained version of MobileNetV2</span>
<span class="c1"># torch_model = module.model</span>

<span class="c1"># scripted_model = torch.jit.script(torch_model)</span>

<span class="c1"># import coremltools</span>
<span class="c1"># mlmodel = coremltools.converters.convert(</span>
<span class="c1">#   scripted_model,</span>
<span class="c1">#   inputs=[coremltools.TensorType(shape=(1, 3, 64, 64))],</span>
<span class="c1"># )</span>


<span class="c1"># mlmodel.save(&quot;faster_rcnn_resnet.mlmodel&quot;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># import torch</span>
<span class="c1"># import torchvision.models.detection as models</span>
<span class="c1"># from torchvision.models.detection.faster_rcnn import FastRCNNPredictor</span>
<span class="c1"># from torchvision.transforms import Compose, Normalize, ToPILImage, ToTensor</span>
<span class="c1"># from contexttimer import Timer</span>
<span class="c1"># import numpy as np</span>
<span class="c1"># import albumentations as A</span>
<span class="c1"># import cv2</span>
<span class="c1"># import warnings</span>
<span class="c1"># from detection_nbdev.utils import visualize</span>
<span class="c1"># from fastai.vision.data import get_grid</span>
<span class="c1"># import pytorch_lightning as pl</span>
<span class="c1"># from src.dataset import XMLDetectionDataModule, XMLDetectionDataset</span>
<span class="c1"># from src.model import TorchVisionDetector</span>
<span class="c1"># from src.metrics import hungarian_loss, bbox_iou</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

